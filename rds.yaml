AWSTemplateFormatVersion: '2010-09-09'

Description: 'CloudFormation Template to create Aurora Postgresql Cluster DB Instance'



###############################################################################

# Parameters 

###############################################################################  



Parameters:



 VPCID:

  Description: "VPC Id" 

  Type: AWS::SSM::Parameter::Value<String>

  Default: /org/member/vpc_id



 Subnet1ID:

  Description: "Pvt Subnet 1"

  Type: AWS::SSM::Parameter::Value<String>

  Default: /org/member/private_subnet_1a



 Subnet2ID:

  Description: "Pvt Subnet 2"

  Type: AWS::SSM::Parameter::Value<String>

  Default: /org/member/private_subnet_2a



 Subnet3ID:

  Description: "Pvt Subnet 3"

  Type: AWS::SSM::Parameter::Value<String>

  Default: /org/member/private_subnet_3a



 Subnet4ID:

  Description: "Pvt Subnet 4"

  Type: AWS::SSM::Parameter::Value<String>

  Default: /org/member/private_subnet_4a

  

 DBClusterName:

  Description: DB Cluster Identifier Name

  Type: String

  MinLength: '1'

  MaxLength: '64'

  AllowedPattern: "^[a-zA-Z]+[0-9a-zA-Z-]*$" 

  ConstraintDescription: Must start with a letter. Only numbers, letters, and - accepted. max length 64 characters 



 DBName:

  Description: Database Name

  Type: String

  MinLength: '1'

  MaxLength: '64'

  AllowedPattern: "^[a-zA-Z]+[0-9a-zA-Z_]*$" 

  ConstraintDescription: Must start with a letter. Only numbers, letters, and _ accepted. max length 64 characters 



 DBPort:

  Description: TCP/IP Port for the Database Instance

  Type: Number

  Default: 5432

  ConstraintDescription: 'Must be in the range [1115-65535]'

  MinValue: 1115

  MaxValue: 65535

   

 DBUsername:

  Description: Database master username

  Type: String

  MinLength: '1'

  MaxLength: '16'

  AllowedPattern: "^[a-zA-Z]+[0-9a-zA-Z_]*$"

  ConstraintDescription: Must start with a letter. Only numbers, letters, and _ accepted. max length 16 characters

  

 DBPassword:

  AllowedPattern: >-

   ^(?=^.{8,255}$)(?=.*[a-z])(?=.*[A-Z])(?=.*\d)((?=.*[^A-Za-z0-9])(?!.*[@/"'])).*$

  ConstraintDescription: >-

   Min 8 chars. Must include 1 uppercase, 1 lowercase, 1 number, 1 (non / @ " ') symbol

  Description: "The database admin account password."

  MaxLength: "64"

  MinLength: "8"

  NoEcho: "True"

  Type: String



 # bv : 2021-04-20 following is updated, we left few intermediate versions, we are at v11.7

 # refer to https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/USER_UpgradeDBInstance.PostgreSQL.html

 DBEngineVersion:

  Description: Select Database Engine Version

  Type: String

  Default: 15.2

  AllowedValues:

   - 9.6.8

   - 9.6.9

   - 9.6.11

   - 9.6.12

   - 9.6.16

   - 10.4

   - 10.5

   - 10.6

   - 10.7

   - 10.11

   - 11.4

   - 11.6

   - 11.7

   - 11.9

   - 11.11

   - 12.2

   - 12.6

   - 13.1

   - 13.2

   - 15.2

   

 DBInstanceClass:

  Default: db.r4.large

  Description: Database Instance Class. db.r5 instance classes are supported for Aurora PostgreSQL 10.6 or later. db.t3.medium instance class is supported for Aurora PostgreSQL 10.7 or later.

  Type: String

  AllowedValues:

  - db.t3.medium

  - db.t3.large

  - db.t3.xlarge

  - db.t3.2xlarge

  - db.r4.large

  - db.r4.xlarge

  - db.r4.2xlarge

  - db.r4.4xlarge

  - db.r4.8xlarge

  - db.r4.16xlarge

  - db.r5.large

  - db.r5.xlarge

  - db.r5.2xlarge

  - db.r5.4xlarge

  - db.r5.8xlarge

  - db.r5.12xlarge

  - db.r5.16xlarge

  - db.r5.24xlarge

  - db.t4g.medium



 DBSnapshotName:

  Description: Optional. DB Snapshot ID to restore database. Leave this blank if you are not restoring from a snapshot.

  Type: String

  Default: ''



 DBAccessCIDR: 

  AllowedPattern: "^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\\/([0-9]|[1-2][0-9]|3[0-2]))$"

  ConstraintDescription: "CIDR block parameter must be in the form x.x.x.x/x"

  Description: "Allowed CIDR block for external access (use VPC CIDR)."

  Type: String

  Default: 10.44.202.0/23



 CustomDBSecurityGroup:

  Description: "ID of the security group (e.g., sg-0234se). One will be created for you if left empty."

  Type: String

  Default: ''



 ClngResourceNamePrefix:

  Type: String

  Description: "Naming prefix to use for all clng core resources (where applicable)"

  Default: cnc-clng-core



 cfMonitoringRoleName:

  Description: PCP needs role names to be prefixed with cnc-, otherwise role creation will fail

  Default: 'cnc-mcpf-rds-enhanced-monitoring-role'

  Type: String 



 cfProdMonitoringEnable:

  Description: Enable Enhanced Monitoring for prod? bv:Leaving blank, but [todo] in phase-2/enhancements

  Type: String

  Default: 'true'



 cfAccountAlias:

  Description: "Account Alias - clng/clmd/clop/clut"

  Type: AWS::SSM::Parameter::Value<String>

  Default: /mcpf/AccountAlias



 # bv though the following is named MskTopicMgrS3PrefixList, it's available

 # where MSK exists, and RDS as well (except for CLOP), per our standards

 cfS3PrefixListId:

  Description: "S3 Prefix List for bucket access"

  Type: AWS::SSM::Parameter::Value<String>

  Default: /mcpf/S3PrefixId



   

 cfVPCESecGrpSecretsMgr:

  Description: "vpc endpoint sg for secrets manager"

  Type: AWS::SSM::Parameter::Value<String>

  Default: /sc/endpoint/vpc-endpoint-sg-secretsmanager

 

###########################################################################

# Mandatory tags that will be added to all resources that support tags

###########################################################################



 EnvironmentStage:

  Type: String

  Description: The environment tag is used to designate the Environment Stage of the associated AWS resource.

  AllowedValues:

   - dev

   - tst

   - sbx

   - trg

   - prf

   - stg

   - prd

  Default: dev



 Application:

  Type: String

  Description: The Application tag is used to designate the application of the associated AWS resource. In this capacity application does not refer to an installed software component, but rather the overall business application that the resource supports.

  AllowedPattern: "^[a-zA-Z]+[a-zA-Z ]+[a-zA-Z]+$"

  ConstraintDescription: provide a valid application name containing only letters and spaces



 ApplicationVersion:

  Type: String

  Description: The ApplicationVersion tag is used to designate the specific version of the application. Format should be in the Pattern - "#.#.#"

  Default: '1.0.0'

  AllowedPattern: '^[a-zA-Z0-9\.\-]+$'

  ConstraintDescription: provide a valid application version

   

 ProjectCostCenter:

  Type: String

  Description: The ProjectCostCenter tag is used to designate the cost center associated with the project of the given AWS resource.

  AllowedPattern: "^[a-zA-Z0-9]+$"

  ConstraintDescription: provide a valid cost center

 

 ServiceOwnersEmailContact:

  Type: String

  Description: The ServiceOwnersEmailContact tag is used to designate business owner(s) email address associated with the given AWS resource for sending outage or maintenance notifications

  AllowedPattern: '^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$'

  ConstraintDescription: provide a valid email address.

   

 NotificationList:

  Type: String

  Description: The Email notification list is used to configure a SNS topic for sending cloudwatch alarm and RDS Event notifications

  AllowedPattern: '^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$'

  ConstraintDescription: provide a valid email address.

   

 Confidentiality:

  Type: String

  Description: The Confidentiality tag is used to designate the confidentiality classification of the data that is associated with the resource.

  AllowedValues:

   - public

   - private

   - confidential

   - pii/phi

   

 Compliance:

  Type: String

  Description: The Compliance tag is used to specify the Compliance level for the AWS resource.

  AllowedValues:

   - hipaa

   - sox

   - fips

   - other

   - none

   

###############################################################################

# Parameter groups

###############################################################################



Metadata:

 AWS::CloudFormation::Interface:

  ParameterGroups:

   -

    Label:

     default: Environment

    Parameters:

     - EnvironmentStage

   -

    Label:

     default: Network configuration

    Parameters:

     - VPCID

     - Subnet1ID

     - Subnet2ID

     - Subnet3ID

     - Subnet4ID

     - CustomDBSecurityGroup

     - ClngResourceNamePrefix

   - 

    Label:

     default: DB Parameters

    Parameters:

     - DBClusterName

     - DBName

     - DBPort

     - DBUsername

     - DBAccessCIDR

     - DBInstanceClass

     - DBEngineVersion

     - DBSnapshotName

     - NotificationList

   -

    Label:

     default: Mandatory Tags

    Parameters:

     - Application

     - ApplicationVersion

     - ProjectCostCenter      

     - ServiceOwnersEmailContact

     - Confidentiality

     - Compliance

      

###############################################################################

# Mappings

###############################################################################

 

Mappings: 

 DBFamilyMap: 

  "9.6.8": 

   "family": "aurora-postgresql9.6"

  "9.6.9": 

   "family": "aurora-postgresql9.6"

  "9.6.11": 

   "family": "aurora-postgresql9.6"

  "9.6.12": 

   "family": "aurora-postgresql9.6"

  "9.6.16": 

   "family": "aurora-postgresql9.6"

  "10.4":

   "family": "aurora-postgresql10"

  "10.5":

   "family": "aurora-postgresql10"

  "10.6":

   "family": "aurora-postgresql10"

  "10.7":

   "family": "aurora-postgresql10"

  "10.11":

   "family": "aurora-postgresql10"

  "11.4":

   "family": "aurora-postgresql11"

  "11.6":

   "family": "aurora-postgresql11"

  "11.7":

   "family": "aurora-postgresql11"

  "11.9":

   "family": "aurora-postgresql11"

  "11.11":

   "family": "aurora-postgresql11"

  "12.2":

   "family": "aurora-postgresql12"

  "12.6":

   "family": "aurora-postgresql12"

  "13.1":

   "family": "aurora-postgresql13"

  "13.2":

   "family": "aurora-postgresql13"

  "15.2":

   "family": "aurora-postgresql15"

    

###############################################################################

# Conditions

############################################################################### 

Conditions:

 IsUseDBSnapshot: !Not [!Equals [!Ref DBSnapshotName, '']]

 IsNotUseDBSnapshot: !Not [Condition: IsUseDBSnapshot]

 IsProd: !Equals [!Ref EnvironmentStage, 'prd']

 IsEnableMonitor: !Not [!Equals [!Ref cfProdMonitoringEnable, '']]

 IsReplica: !Not [!Equals [!Ref EnvironmentStage, 'dev']]

 DoEnableIAM: !Not [!Equals [!Ref DBEngineVersion, '9.6.8']]

 CreateSecurityGroup: !Equals [!Ref CustomDBSecurityGroup, '']

###############################################################################

# Resources 

###############################################################################  

Resources:



 # Create Initial Security Groups for Aurora RDS clients

 # bv: 2021-04-20, due to Dome9 High findings on excessive number of hosts, 

 # about 28 o/b egress rules are being removed, if needed see commit-id in

 # platorm repo - c7112c02 or earlier. We also removed most of the commented

 # out lines for better readability. A copy with today's date is saved in archive

 # we are removing the -rds-client-sg, as we are fine with cnc-99 sg itself.

 # we are going to leave this commented, not totally remove, in case we need this

  

 #ClngRdsClientSecurityGroup:

 # Type: 'AWS::EC2::SecurityGroup'

 # Metadata:

 #  cfn_nag:

 #   rules_to_suppress:

 #    - id: W28

 #     reason: 'Resource found with an explicit name, this disallows updates that require replacement of this resource'

 #    - id: F1000

 #     reason: '(F1000) Missing egress rule means all traffic is allowed outbound. Make this explicit if it is desired configuration'

 # Properties:

 #  GroupName: !Sub '${ClngResourceNamePrefix}-${EnvironmentStage}-rds-client-sg'

 #  GroupDescription: Aurora RDS DB Cluster Security Group

 #  VpcId: !Ref VPCID

 #  SecurityGroupEgress:

 #   - CidrIp: 127.0.0.1/32

 #    IpProtocol: "-1" 

     

 DBSNSTopic:

  Type: AWS::SNS::Topic

  DeletionPolicy: Retain

  Properties:

   Subscription:

   - Endpoint: !Ref NotificationList

    Protocol: email

     

 DBSubnetGroup:

  Type: 'AWS::RDS::DBSubnetGroup'

  DeletionPolicy: Retain

  Properties:

   DBSubnetGroupDescription: !Ref 'AWS::StackName'

   SubnetIds:

   - !Ref Subnet1ID

   - !Ref Subnet2ID

   - !Ref Subnet3ID

   - !Ref Subnet4ID 



 RDSSecurityGroup:

  Type: 'AWS::EC2::SecurityGroup'

  DeletionPolicy: Retain

  Metadata:

   cfn_nag:

    rules_to_suppress:

     - id: W28

      reason: 'Resource found with an explicit name, this disallows updates that require replacement of this resource'

     - id: F1000

      reason: '(F1000) Missing egress rule means all traffic is allowed outbound. Make this explicit if it is desired configuration'

  Properties:

   GroupDescription: !Ref 'AWS::StackName'

   SecurityGroupEgress: 

    - CidrIp: 127.0.0.1/32

     IpProtocol: "-1"

   VpcId: !Ref VPCID

   Tags:

   - Key: Name

    Value: !Sub '${AWS::StackName}-AuroraClusterSecurityGroup'



 # bv following is to depend on the SG group creation and then attach

 # this is the self referencing SG to itself to allow import etc.

 RDSSecurityGroupIngress1:

  Type: AWS::EC2::SecurityGroupIngress

  DeletionPolicy: Retain

  DependsOn: RDSSecurityGroup

  Properties:

   Description: Allow self access

   IpProtocol: tcp

   FromPort: 0

   ToPort: 65535

   SourceSecurityGroupId:

    Fn::GetAtt:

    - RDSSecurityGroup

    - GroupId

   GroupId:

    Fn::GetAtt:

    - RDSSecurityGroup

    - GroupId



 RDSSecurityGroupIngress2:

  Type: AWS::EC2::SecurityGroupIngress

  DeletionPolicy: Retain

  DependsOn: RDSSecurityGroup

  Properties:

   Description: Allow access to S3

   IpProtocol: tcp 

   FromPort: !Ref DBPort

   ToPort: !Ref DBPort

   SourcePrefixListId: !Ref cfS3PrefixListId

   GroupId:

    Fn::GetAtt:

    - RDSSecurityGroup

    - GroupId

    

 #RDSSecurityGroupIngress3:

 # Type: AWS::EC2::SecurityGroupIngress

 # DependsOn: RDSSecurityGroup

 # Properties:

 #  Description: Allow access to EKS Cluster

 #  IpProtocol: tcp

 #  FromPort: !Ref DBPort

 #  ToPort: !Ref DBPort

 #  SourceSecurityGroupId: {"Fn::ImportValue" : {"Fn::Sub" : "eksctl-cnc-${cfAccountAlias}-core-${EnvironmentStage}-${AWS::Region}-cluster::ClusterSecurityGroupId"}}

 #  GroupId:

 #   Fn::GetAtt:

 #   - RDSSecurityGroup

 #   - GroupId



 RDSSecurityGroupIngress4:

  Type: AWS::EC2::SecurityGroupIngress

  DeletionPolicy: Retain

  DependsOn: RDSSecurityGroup

  Properties:

   Description: Allow access to secrets manager thru vpce

   IpProtocol: tcp 

   FromPort: !Ref DBPort

   ToPort: !Ref DBPort

   SourceSecurityGroupId: !Ref cfVPCESecGrpSecretsMgr

   GroupId:

    Fn::GetAtt:

    - RDSSecurityGroup

    - GroupId



 RDSSecurityGroupEgress1:

  Type: AWS::EC2::SecurityGroupEgress

  DeletionPolicy: Retain

  DependsOn: RDSSecurityGroup

  Properties:

   Description: Allows access from S3

   IpProtocol: tcp

   FromPort: !Ref DBPort

   ToPort: !Ref DBPort

   DestinationPrefixListId: !Ref cfS3PrefixListId 

   GroupId: 

    Fn::GetAtt:

    - RDSSecurityGroup

    - GroupId



 RDSSecurityGroupEgress2:

  Type: AWS::EC2::SecurityGroupEgress

  DeletionPolicy: Retain

  DependsOn: RDSSecurityGroup

  Properties:

   Description: Allows access from VPCE Secrets Manager 

   IpProtocol: tcp

   FromPort: !Ref DBPort

   ToPort: !Ref DBPort

   DestinationSecurityGroupId: !Ref cfVPCESecGrpSecretsMgr

   GroupId:

    Fn::GetAtt:

    - RDSSecurityGroup

    - GroupId



 RDSDBClusterParameterGroup:

  Type: AWS::RDS::DBClusterParameterGroup

  DeletionPolicy: Retain

  Properties:

   Description: !Join [ "- ", [ "Aurora PG Cluster Parameter Group for CFN Stack ", !Ref DBName ] ]

   Family: !FindInMap [DBFamilyMap, !Ref DBEngineVersion, "family"] 

   Parameters:

    rds.force_ssl: 1

     

 DBParamGroup:

  Type: AWS::RDS::DBParameterGroup

  DeletionPolicy: Retain

  Properties:

   Description: !Join [ "- ", [ "Aurora PG DB Instance Parameter Group for CFN Stack ", !Ref DBName ] ]

   Family: !FindInMap [DBFamilyMap, !Ref DBEngineVersion, "family"] 

   Parameters:

    shared_preload_libraries: auto_explain,pg_stat_statements,pg_hint_plan,pgaudit

    log_statement: "ddl"

    log_connections: '1'

    log_disconnections: '1'

    log_lock_waits: '1'

    log_min_duration_statement: '5000'

    auto_explain.log_min_duration: '5000'

    auto_explain.log_verbose: '1'

    log_rotation_age: '1440'

    log_rotation_size: '102400'

    rds.log_retention_period: '10080'

    random_page_cost: '1'

    track_activity_query_size: '16384'

    idle_in_transaction_session_timeout: '7200000'

    statement_timeout: '7200000'

    search_path: '"$user",public'



 AuroraKMSCMK:

  Type: 'AWS::KMS::Key'

  DeletionPolicy: Retain

  Properties:

   Enabled: True

   EnableKeyRotation: True

   KeyPolicy:

    Version: '2012-10-17'

    Statement:

    - Effect: Allow

     Principal:

      AWS: !Sub 'arn:aws:iam::${AWS::AccountId}:root'

     Action: 'kms:*'

     Resource: '*'

    - Effect: Allow

     Principal:

      AWS: '*'

     Action:

     - 'kms:Encrypt'

     - 'kms:Decrypt'

     - 'kms:ReEncrypt*'

     - 'kms:GenerateDataKey*'

     - 'kms:CreateGrant'

     - 'kms:ListGrants'

     - 'kms:DescribeKey'

     Resource: '*'

     Condition:

      StringEquals:

       'kms:CallerAccount': !Ref 'AWS::AccountId'

       'kms:ViaService': !Sub 'rds.${AWS::Region}.amazonaws.com'



 AuroraKMSCMKAlias:

  Type: 'AWS::KMS::Alias'

  DeletionPolicy: Retain

  DependsOn: AuroraDBCluster

  Properties:

   AliasName: !Sub 'alias/${AuroraDBCluster}'

   TargetKeyId: !Ref AuroraKMSCMK



 AuroraDBCluster:

  Type: AWS::RDS::DBCluster

  #DeletionPolicy: Snapshot

  DeletionPolicy: Retain

  UpdateReplacePolicy: Snapshot

  #DependsOn: ClngRdsClientSecurityGroup

  Properties:

   DBClusterIdentifier: !Ref DBClusterName

   Engine: aurora-postgresql

   EngineVersion: !Ref DBEngineVersion

   DatabaseName: !If [IsUseDBSnapshot, !Ref "AWS::NoValue", !Ref DBName]

   Port: !Ref DBPort

#   MasterUsername:

#    !If [IsUseDBSnapshot, !Ref "AWS::NoValue", !Join ['', ['{{resolve:secretsmanager:', !Ref AuroraMasterSecret, ':SecretString:username}}' ]]]

#   MasterUserPassword:

#    !If [IsUseDBSnapshot, !Ref "AWS::NoValue", !Join ['', ['{{resolve:secretsmanager:', !Ref AuroraMasterSecret, ':SecretString:password}}' ]]]

   MasterUsername:

    !If [IsUseDBSnapshot, !Ref "AWS::NoValue", !Ref DBUsername]

   MasterUserPassword:

    !If [IsUseDBSnapshot, !Ref "AWS::NoValue", !Ref DBPassword]

   DBSubnetGroupName: !Ref DBSubnetGroup

   VpcSecurityGroupIds:

    !If

     - CreateSecurityGroup

     - [!Ref RDSSecurityGroup]

     - [!Ref CustomDBSecurityGroup]  

   #defo Dome9 finding, increased lower envs to save backups for 10 days instead of 7

   BackupRetentionPeriod: !If [IsProd, 35, 10]

   DBClusterParameterGroupName: !Ref RDSDBClusterParameterGroup

   SnapshotIdentifier: !If [IsUseDBSnapshot, !Ref DBSnapshotName, !Ref "AWS::NoValue"]

   StorageEncrypted: !If [IsUseDBSnapshot, !Ref "AWS::NoValue", true]

   KmsKeyId: !If [IsNotUseDBSnapshot, !Ref AuroraKMSCMK, !Ref 'AWS::NoValue']

   EnableIAMDatabaseAuthentication: !If [DoEnableIAM, true, !Ref "AWS::NoValue"]

   Tags:

    -

     Key: EnvironmentStage

     Value: !Ref EnvironmentStage

    -

     Key: Application

     Value: !Ref Application

    -

     Key: ApplicationVersion

     Value: !Ref ApplicationVersion

    -

     Key: ProjectCostCenter

     Value: !Ref ProjectCostCenter

    -

     Key: ServiceOwnersEmailContact

     Value: !Ref ServiceOwnersEmailContact      

    -

     Key: Confidentiality

     Value: !Ref Confidentiality

    -

     Key: Compliance

     Value: !Ref Compliance

     

 AuroraDBFirstInstance:

  Type: AWS::RDS::DBInstance

  DeletionPolicy: Retain

  Properties:

   DBInstanceClass: !Ref DBInstanceClass

   DBClusterIdentifier: !Ref AuroraDBCluster

   DBInstanceIdentifier: !Join [ "-", [ !Ref DBName, !Ref AWS::Region, "inst1" ] ]

   Engine: aurora-postgresql

   EngineVersion: !Ref DBEngineVersion

   DBParameterGroupName: !Ref DBParamGroup

   #defo Made Changes to Enable Monitoring - Dome9 Finding

   MonitoringInterval: !If [IsEnableMonitor, 60, 0]

   #YG 9/14/21 

   #Following needs an ARN rather than role name

   #MonitoringRoleArn: !If [IsEnableMonitor, !Ref cfMonitoringRoleName, !Ref "AWS::NoValue"]

   MonitoringRoleArn: !If [IsEnableMonitor, !ImportValue McpfRdsEnhancedMonitoringRoleArn, !Ref "AWS::NoValue"]

   #defo Removing Production Logic to disable minor version upgrades - Dome9 Finding

   AutoMinorVersionUpgrade: true

   DBSubnetGroupName: !Ref DBSubnetGroup

   PubliclyAccessible: false

   EnablePerformanceInsights: true

   PerformanceInsightsKMSKeyId: !Ref AuroraKMSCMK

   PerformanceInsightsRetentionPeriod: !If [IsProd, 731, 7]

   Tags:

    -

     Key: EnvironmentStage

     Value: !Ref EnvironmentStage

    -

     Key: Application

     Value: !Ref Application

    -

     Key: ApplicationVersion

     Value: !Ref ApplicationVersion

    -

     Key: ProjectCostCenter

     Value: !Ref ProjectCostCenter

    -

     Key: ServiceOwnersEmailContact

     Value: !Ref ServiceOwnersEmailContact

    -

     Key: Confidentiality

     Value: !Ref Confidentiality

    -

     Key: Compliance

     Value: !Ref Compliance



 AuroraDBSecondInstance:

  Condition: IsReplica

  Type: AWS::RDS::DBInstance

  DeletionPolicy: Retain

  DependsOn: 

   - AuroraDBFirstInstance

  Properties:

   DBInstanceClass:

    Ref: DBInstanceClass

   DBClusterIdentifier: !Ref AuroraDBCluster

   DBInstanceIdentifier: !Join [ "-", [ !Ref DBName, !Ref AWS::Region, "inst2" ] ]

   Engine: aurora-postgresql

   EngineVersion: !Ref DBEngineVersion

   DBParameterGroupName:

    Ref: DBParamGroup

   #defo Made Changes to Enable Monitoring - Dome9 Finding

   MonitoringInterval: !If [IsEnableMonitor, 60, 0]

   #YG 9/14/21 

   #Following needs an ARN rather than role name

   #MonitoringRoleArn: !If [IsEnableMonitor, !Ref cfMonitoringRoleName, !Ref "AWS::NoValue"]

   MonitoringRoleArn: !If [IsEnableMonitor, !ImportValue McpfRdsEnhancedMonitoringRoleArn, !Ref "AWS::NoValue"]

   #defo Removing Production Logic to disable minor version upgrades - Dome9 Finding

   AutoMinorVersionUpgrade: true

   DBSubnetGroupName: !Ref DBSubnetGroup

   PubliclyAccessible: false

   EnablePerformanceInsights: true

   PerformanceInsightsKMSKeyId: !Ref AuroraKMSCMK

   PerformanceInsightsRetentionPeriod: !If [IsProd, 731, 7]

   Tags:

    -

     Key: EnvironmentStage

     Value: !Ref EnvironmentStage

    -

     Key: Application

     Value: !Ref Application

    -

     Key: ApplicationVersion

     Value: !Ref ApplicationVersion

    -

     Key: ProjectCostCenter

     Value: !Ref ProjectCostCenter

    -

     Key: ServiceOwnersEmailContact

     Value: !Ref ServiceOwnersEmailContact

    -

     Key: Confidentiality

     Value: !Ref Confidentiality

    -

     Key: Compliance

     Value: !Ref Compliance

      

 CPUUtilizationAlarm1:

  Type: "AWS::CloudWatch::Alarm"

  DeletionPolicy: Retain

  Properties:

   ActionsEnabled: true

   AlarmActions:

   - Ref: DBSNSTopic

   AlarmDescription: 'CPU_Utilization'

   Dimensions:

   - Name: DBInstanceIdentifier

    Value:

     Ref: AuroraDBFirstInstance

   MetricName: CPUUtilization

   Statistic: Maximum

   Namespace: 'AWS/RDS'

   Threshold: '80'

   Unit: Percent

   ComparisonOperator: 'GreaterThanOrEqualToThreshold'

   Period: '60'

   EvaluationPeriods: '5'

   TreatMissingData: 'notBreaching'

    

 CPUUtilizationAlarm2:

  Condition: IsReplica

  Type: "AWS::CloudWatch::Alarm"

  DeletionPolicy: Retain

  Properties:

   ActionsEnabled: true

   AlarmActions:

   - Ref: DBSNSTopic

   AlarmDescription: 'CPU_Utilization'

   Dimensions:

   - Name: DBInstanceIdentifier

    Value:

     Ref: AuroraDBSecondInstance

   MetricName: CPUUtilization

   Statistic: Maximum

   Namespace: 'AWS/RDS'

   Threshold: '80'

   Unit: Percent

   ComparisonOperator: 'GreaterThanOrEqualToThreshold'

   Period: '60'

   EvaluationPeriods: '5'

   TreatMissingData: 'notBreaching'

    

 MaxUsedTxIDsAlarm1:

  Type: "AWS::CloudWatch::Alarm"

  DeletionPolicy: Retain

  Properties:

   ActionsEnabled: true

   AlarmActions:

   - Ref: DBSNSTopic

   AlarmDescription: 'Maximum Used Transaction IDs'

   Dimensions:

   - Name: DBInstanceIdentifier

    Value:

     Ref: AuroraDBFirstInstance

   MetricName: 'MaximumUsedTransactionIDs'

   Statistic: Average

   Namespace: 'AWS/RDS'

   Threshold: '600000000'

   Unit: Count

   ComparisonOperator: 'GreaterThanOrEqualToThreshold'

   Period: '60'

   EvaluationPeriods: '5'

   TreatMissingData: 'notBreaching'

    

 MaxUsedTxIDsAlarm2:

  Condition: IsReplica

  Type: "AWS::CloudWatch::Alarm"

  DeletionPolicy: Retain

  Properties:

   ActionsEnabled: true

   AlarmActions:

   - Ref: DBSNSTopic

   AlarmDescription: 'Maximum Used Transaction IDs'

   Dimensions:

   - Name: DBInstanceIdentifier

    Value:

     Ref: AuroraDBSecondInstance

   MetricName: 'MaximumUsedTransactionIDs'

   Statistic: Average

   Namespace: 'AWS/RDS'

   Threshold: '600000000'

   Unit: Count

   ComparisonOperator: 'GreaterThanOrEqualToThreshold'

   Period: '60'

   EvaluationPeriods: '5'

   TreatMissingData: 'notBreaching'



 FreeLocalStorageAlarm1:

  Type: "AWS::CloudWatch::Alarm"

  DeletionPolicy: Retain

  Properties:

   ActionsEnabled: true

   AlarmActions:

   - Ref: DBSNSTopic

   AlarmDescription: 'Free Local Storage'

   Dimensions:

   - Name: DBInstanceIdentifier

    Value:

     Ref: AuroraDBFirstInstance

   MetricName: 'FreeLocalStorage'

   Statistic: Average

   Namespace: 'AWS/RDS'

   Threshold: '5368709120'

   Unit: Bytes

   ComparisonOperator: 'LessThanOrEqualToThreshold'

   Period: '60'

   EvaluationPeriods: '5'

   TreatMissingData: 'notBreaching'

    

 FreeLocalStorageAlarm2:

  Condition: IsReplica

  Type: "AWS::CloudWatch::Alarm"

  DeletionPolicy: Retain

  Properties:

   ActionsEnabled: true

   AlarmActions:

   - Ref: DBSNSTopic

   AlarmDescription: 'Free Local Storage'

   Dimensions:

   - Name: DBInstanceIdentifier

    Value:

     Ref: AuroraDBSecondInstance

   MetricName: 'FreeLocalStorage'

   Statistic: Average

   Namespace: 'AWS/RDS'

   Threshold: '5368709120'

   Unit: Bytes

   ComparisonOperator: 'LessThanOrEqualToThreshold'

   Period: '60'

   EvaluationPeriods: '5'

   TreatMissingData: 'notBreaching'   

    

 DatabaseClusterEventSubscription:

  Type: 'AWS::RDS::EventSubscription'

  DeletionPolicy: Retain

  Properties:

   SnsTopicArn: !Ref DBSNSTopic

   SourceType: 'db-cluster'



 DatabaseInstanceEventSubscription:

  Type: 'AWS::RDS::EventSubscription'

  DeletionPolicy: Retain

  Properties:

   SnsTopicArn: !Ref DBSNSTopic

   SourceType: 'db-instance'

    

 DBParameterGroupEventSubscription:

  Type: 'AWS::RDS::EventSubscription'

  DeletionPolicy: Retain

  Properties:

   SnsTopicArn: !Ref DBSNSTopic

   SourceType: 'db-parameter-group'

  

###############################################################################

# Outputs 

###############################################################################  

Outputs:

 #ClngRdsClientSGId:

 # Description: Aurora RDS Client SG ID

 # Value: !Ref ClngRdsClientSecurityGroup

 # Export:

 #  Name: !Sub '${ClngResourceNamePrefix}-${EnvironmentStage}-ClngRdsSGClientId'

 ClngRdsClusterSGId:

  Description: Aurora RDS Cluster SG ID

  Value: !Ref RDSSecurityGroup

  Export:

   Name: !Sub '${ClngResourceNamePrefix}-${EnvironmentStage}-ClngRdsClusterSGId'

 ClusterEndpoint:

  Description: 'Aurora Cluster/Writer Endpoint'

  Value: !GetAtt 'AuroraDBCluster.Endpoint.Address'

 ReaderEndpoint:

  Description: 'Aurora Reader Endpoint'

  Value: !GetAtt 'AuroraDBCluster.ReadEndpoint.Address'

 Port:

  Description: 'Aurora Endpoint Port'

  Value: !GetAtt 'AuroraDBCluster.Endpoint.Port'

 DBUsername:

  Description: 'Database master username'

  Value: !Ref DBUsername

 DBName:

  Description: 'Database Name'

  Value: !Ref DBName

 PSQLCommandLine:   

  Description: PSQL Command Line

  Value: !Join

       - ''

       - - 'psql --host='

        - !GetAtt 'AuroraDBCluster.Endpoint.Address' 

        - ' --port='

        - !GetAtt 'AuroraDBCluster.Endpoint.Port'

        - ' --username='

        - !Ref DBUsername

        - ' --dbname='

        - !Ref DBName

 JDBCConnectionString:

  Description: JDBC connection string for database

  Value:

   Fn::Join:

   - ''

   - - jdbc:postgresql://

    - Fn::GetAtt:

     - AuroraDBCluster

     - Endpoint.Address

    - ":" 

    - Fn::GetAtt:

     - AuroraDBCluster

     - Endpoint.Port

    - "/" 

    - Ref: DBName